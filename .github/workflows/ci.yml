# General CI Workflow for ArtiCurated Order Management System
# This workflow runs on all PRs and pushes to main and feature branches.

name: ci

on:
    push:
        branches:
            - main
            - "story/*"
    pull_request:
        branches:
            - main
            - "story/*"

jobs:
    build-test-validate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
            - name: Install dependencies
              run: |
                  pip install -r requirements.txt
            - name: Run tests and coverage
              run: |
                  pytest --cov=app --cov-report=xml
            - name: Run static analysis
              run: |
                  ruff check app/
                  mypy app/
                  bandit -r app/
                  safety check
            - name: Check coverage threshold
              run: |
                  coverage report --fail-under=85
            - name: Require human review
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.pulls.requestReviewers({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.issue.number,
                        reviewers: ['team-lead', 'security-reviewer']
                      })
            - name: Block merge if requirements not met
              if: failure()
              run: exit 1
